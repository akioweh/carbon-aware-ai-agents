openapi: 3.0.3
info:
  title: Stats API (Stats Component)
  description: |
    Unified API for environmental and operational time-series data to support carbon-aware scheduling.
    
    ## Design Philosophy
    
    All metrics follow a **normalized time-series structure** with:
    - Location-based hierarchy: `/locations/{location}/metrics/{metric}`
    - Unified query parameters: `start`, `end`, `include_forecast`
    - Consistent response format with metadata (location, metric, unit)
    - Clear distinction between historical data and forecasts (`is_forecast` flag)
    
    ## Data Sources
    
    The Stats component integrates and normalizes data from multiple external sources:
    - **carbon**: Grid carbon intensity (kg COâ‚‚/kWh) - time-series with forecasts
    - **load**: Data center load and capacity - time-series with resource availability
    - **weather**: Temperature and humidity - time-series affecting cooling efficiency
    - **cost**: Compute costs - relatively static pricing information
    
    Legacy endpoints (`/history`, `/latest`) provide backward compatibility for load and greenness tracking.
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: http://localhost:5000
    description: Local development server

tags:
  - name: History
    description: Legacy historical data endpoints (load and greenness tracking)
  - name: Latest
    description: Legacy latest data endpoints
  - name: Context
    description: |
      Unified location-based metrics API.
      All metrics follow the same time-series structure and query patterns.

paths:
  /history:
    get:
      tags:
        - History
      summary: Get full history
      description: Returns the complete history of all data points including timestamp, load, and greenness
      operationId: getFullHistory
      responses:
        '200':
          description: Successful response with full history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FullDataPoint'
              example:
                - timestamp: "2025-11-05T18:20:39.679404"
                  load: 8.168924463462984
                  greenness: 48.67735982423504
                - timestamp: "2025-11-05T18:25:39.679404"
                  load: 9.132001328854178
                  greenness: 43.65320150893125

  /load/history:
    get:
      tags:
        - History
      summary: Get load history
      description: Returns historical data containing only timestamp and load values
      operationId: getLoadHistory
      responses:
        '200':
          description: Successful response with load history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LoadDataPoint'
              example:
                - timestamp: "2025-11-05T18:20:39.679404"
                  load: 8.168924463462984
                - timestamp: "2025-11-05T18:25:39.679404"
                  load: 9.132001328854178

  /greenness/history:
    get:
      tags:
        - History
      summary: Get greenness history
      description: Returns historical data containing only timestamp and greenness values
      operationId: getGreennessHistory
      responses:
        '200':
          description: Successful response with greenness history
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GreennessDataPoint'
              example:
                - timestamp: "2025-11-05T18:20:39.679404"
                  greenness: 48.67735982423504
                - timestamp: "2025-11-05T18:25:39.679404"
                  greenness: 43.65320150893125

  /latest:
    get:
      tags:
        - Latest
      summary: Get latest data
      description: Returns the most recent data point with timestamp, load, and greenness
      operationId: getLatest
      responses:
        '200':
          description: Successful response with latest data point
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FullDataPoint'
              example:
                timestamp: "2025-12-05T18:20:39.679404"
                load: 25.5
                greenness: 75.3

  /load/latest:
    get:
      tags:
        - Latest
      summary: Get latest load
      description: Returns the most recent load data point with timestamp and load value
      operationId: getLatestLoad
      responses:
        '200':
          description: Successful response with latest load data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoadDataPoint'
              example:
                timestamp: "2025-12-05T18:20:39.679404"
                load: 25.5

  /greenness/latest:
    get:
      tags:
        - Latest
      summary: Get latest greenness
      description: Returns the most recent greenness data point with timestamp and greenness value
      operationId: getLatestGreenness
      responses:
        '200':
          description: Successful response with latest greenness data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GreennessDataPoint'
              example:
                timestamp: "2025-12-05T18:20:39.679404"
                greenness: 75.3

  /locations:
    get:
      tags:
        - Context
      summary: List available locations
      description: Returns all available data center locations
      responses:
        '200':
          description: List of locations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Location'
              example:
                - location_id: "dc1"
                  name: "Data Center 1"
                  region: "us-east"
                - location_id: "dc2"
                  name: "Data Center 2"
                  region: "us-west"

  /locations/{location}/metrics/carbon:
    get:
      tags:
        - Context
      summary: Get carbon intensity data
      description: |
        Returns grid carbon intensity time-series data for a location.
        Supports historical data and future forecasts.
      parameters:
        - name: location
          in: path
          required: true
          description: Location identifier (use 'all' for all locations)
          schema:
            type: string
          example: "dc1"
        - name: start
          in: query
          description: Start time (ISO 8601). Defaults to current time if forecasting, or 24h ago if historical.
          schema:
            type: string
            format: date-time
          example: "2025-12-08T00:00:00Z"
        - name: end
          in: query
          description: End time (ISO 8601). Defaults to 24h from start.
          schema:
            type: string
            format: date-time
          example: "2025-12-09T00:00:00Z"
        - name: include_forecast
          in: query
          description: Include forecast data beyond current time
          schema:
            type: boolean
            default: true
          example: true
      responses:
        '200':
          description: Carbon intensity time-series
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricTimeSeries'
              example:
                location_id: "dc1"
                metric: "carbon_intensity"
                unit: "kg_co2_per_kwh"
                data:
                  - timestamp: "2025-12-08T00:00:00Z"
                    value: 0.25
                    is_forecast: false
                  - timestamp: "2025-12-08T01:00:00Z"
                    value: 0.22
                    is_forecast: true
                  - timestamp: "2025-12-08T02:00:00Z"
                    value: 0.15
                    is_forecast: true

  /locations/{location}/metrics/load:
    get:
      tags:
        - Context
      summary: Get data center load data
      description: |
        Returns data center load and capacity time-series data.
        Includes current load, capacity, and available resources.
      parameters:
        - name: location
          in: path
          required: true
          description: Location identifier
          schema:
            type: string
          example: "dc1"
        - name: start
          in: query
          description: Start time (ISO 8601). Defaults to 24h ago.
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          description: End time (ISO 8601). Defaults to now.
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Load time-series with capacity info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoadMetricTimeSeries'
              example:
                location_id: "dc1"
                metric: "load"
                unit: "utilization_units"
                capacity:
                  max_load: 50.0
                  total_gpus: 32
                data:
                  - timestamp: "2025-12-08T00:00:00Z"
                    value: 25.5
                    available_gpus: 16
                  - timestamp: "2025-12-08T01:00:00Z"
                    value: 28.0
                    available_gpus: 14

  /locations/{location}/metrics/weather:
    get:
      tags:
        - Context
      summary: Get weather data
      description: |
        Returns weather time-series data that affects data center cooling efficiency.
      parameters:
        - name: location
          in: path
          required: true
          description: Location identifier
          schema:
            type: string
          example: "dc1"
        - name: start
          in: query
          description: Start time (ISO 8601). Defaults to 24h ago.
          schema:
            type: string
            format: date-time
        - name: end
          in: query
          description: End time (ISO 8601). Defaults to now.
          schema:
            type: string
            format: date-time
        - name: include_forecast
          in: query
          description: Include weather forecast
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Weather time-series
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WeatherMetricTimeSeries'
              example:
                location_id: "dc1"
                metric: "weather"
                data:
                  - timestamp: "2025-12-08T00:00:00Z"
                    temperature_celsius: 22
                    humidity_percent: 65
                    is_forecast: false

  /locations/{location}/metrics/cost:
    get:
      tags:
        - Context
      summary: Get compute cost data
      description: |
        Returns compute cost information. Costs change infrequently but are
        tracked over time for historical analysis.
      parameters:
        - name: location
          in: path
          required: true
          description: Location identifier (use 'all' for all locations)
          schema:
            type: string
          example: "dc1"
      responses:
        '200':
          description: Current cost information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CostMetric'
              example:
                location_id: "dc1"
                metric: "cost"
                currency: "USD"
                effective_date: "2025-12-01T00:00:00Z"
                rates:
                  cost_per_gpu_hour: 2.50
                  cost_per_cpu_hour: 0.10
                  cost_per_gb_hour: 0.01

components:
  schemas:
    FullDataPoint:
      type: object
      description: Complete data point with timestamp, load, and greenness
      required:
        - timestamp
        - load
        - greenness
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 formatted timestamp
          example: "2025-12-05T18:20:39.679404"
        load:
          type: number
          format: float
          description: Data center load value (0-50, where 50 is max capacity)
          minimum: 0
          maximum: 50
          example: 25.5
        greenness:
          type: number
          format: float
          description: Energy greenness score (0-100, higher is greener)
          minimum: 0
          maximum: 100
          example: 75.3
    
    LoadDataPoint:
      type: object
      description: Data point containing timestamp and load
      required:
        - timestamp
        - load
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 formatted timestamp
          example: "2025-12-05T18:20:39.679404"
        load:
          type: number
          format: float
          description: Data center load value (0-50, where 50 is max capacity)
          minimum: 0
          maximum: 50
          example: 25.5
    
    GreennessDataPoint:
      type: object
      description: Data point containing timestamp and greenness
      required:
        - timestamp
        - greenness
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 formatted timestamp
          example: "2025-12-05T18:20:39.679404"
        greenness:
          type: number
          format: float
          description: Energy greenness score (0-100, higher is greener)
          minimum: 0
          maximum: 100
          example: 75.3
    
    Location:
      type: object
      description: A data center location
      required:
        - location_id
        - name
      properties:
        location_id:
          type: string
          description: Unique location identifier
          example: "dc1"
        name:
          type: string
          description: Human-readable location name
          example: "Data Center 1"
        region:
          type: string
          description: Geographic region
          example: "us-east"
    
    MetricTimeSeries:
      type: object
      description: |
        Unified time-series structure for metrics.
        All time-series data follows this normalized format.
      required:
        - location_id
        - metric
        - unit
        - data
      properties:
        location_id:
          type: string
          description: Location identifier
          example: "dc1"
        metric:
          type: string
          description: Metric name
          example: "carbon_intensity"
        unit:
          type: string
          description: Unit of measurement
          example: "kg_co2_per_kwh"
        data:
          type: array
          description: Time-series data points
          items:
            $ref: '#/components/schemas/TimeSeriesPoint'
    
    TimeSeriesPoint:
      type: object
      description: A single point in a time-series
      required:
        - timestamp
        - value
      properties:
        timestamp:
          type: string
          format: date-time
          description: Time of measurement or forecast
          example: "2025-12-08T00:00:00Z"
        value:
          type: number
          description: Metric value at this time
          example: 0.25
        is_forecast:
          type: boolean
          description: Whether this is a forecast (future) or historical/current data
          default: false
          example: true
    
    LoadMetricTimeSeries:
      type: object
      description: Load time-series with capacity information
      required:
        - location_id
        - metric
        - unit
        - capacity
        - data
      properties:
        location_id:
          type: string
          example: "dc1"
        metric:
          type: string
          example: "load"
        unit:
          type: string
          example: "utilization_units"
        capacity:
          $ref: '#/components/schemas/CapacityInfo'
        data:
          type: array
          items:
            $ref: '#/components/schemas/LoadTimeSeriesPoint'
    
    CapacityInfo:
      type: object
      description: Capacity limits for a location
      properties:
        max_load:
          type: number
          description: Maximum load capacity
          example: 50.0
        total_gpus:
          type: integer
          description: Total number of GPUs
          example: 32
    
    LoadTimeSeriesPoint:
      type: object
      description: Load data point with resource availability
      required:
        - timestamp
        - value
      properties:
        timestamp:
          type: string
          format: date-time
          example: "2025-12-08T00:00:00Z"
        value:
          type: number
          description: Load value
          example: 25.5
        available_gpus:
          type: integer
          description: Number of GPUs available at this time
          example: 16
    
    WeatherMetricTimeSeries:
      type: object
      description: Weather time-series data
      required:
        - location_id
        - metric
        - data
      properties:
        location_id:
          type: string
          example: "dc1"
        metric:
          type: string
          example: "weather"
        data:
          type: array
          items:
            $ref: '#/components/schemas/WeatherTimeSeriesPoint'
    
    WeatherTimeSeriesPoint:
      type: object
      description: Weather data at a point in time
      required:
        - timestamp
        - temperature_celsius
      properties:
        timestamp:
          type: string
          format: date-time
          example: "2025-12-08T00:00:00Z"
        temperature_celsius:
          type: number
          description: Temperature in Celsius
          example: 22
        humidity_percent:
          type: number
          description: Relative humidity percentage
          minimum: 0
          maximum: 100
          example: 65
        is_forecast:
          type: boolean
          description: Whether this is forecast data
          default: false
    
    CostMetric:
      type: object
      description: Cost information for a location
      required:
        - location_id
        - metric
        - currency
        - rates
      properties:
        location_id:
          type: string
          example: "dc1"
        metric:
          type: string
          example: "cost"
        currency:
          type: string
          description: Currency code
          example: "USD"
        effective_date:
          type: string
          format: date-time
          description: When these rates became effective
          example: "2025-12-01T00:00:00Z"
        rates:
          $ref: '#/components/schemas/CostRates'
    
    CostRates:
      type: object
      description: Cost rates for various compute resources
      properties:
        cost_per_gpu_hour:
          type: number
          description: Cost per GPU hour
          example: 2.50
        cost_per_cpu_hour:
          type: number
          description: Cost per CPU hour
          example: 0.10
        cost_per_gb_hour:
          type: number
          description: Cost per GB of memory per hour
          example: 0.01
